{
  "actions": {
    "sendEmail": {
      "parameters": [
        {"name": "userIds", "required": true},
        {"name": "comment", "required": true}
      ],
      "pipeline": [
        {
          "action": "find",
          "args": {
            "collection": "users",
            "database": "planner",
            "query": {
              "_id": {
                "$in": "$$vars.userIds"
              }
            }
          },
          "let": {
            "userIds": "$$args.userIds"
          },
          "service": "mdb1"
        },
        {
          "action": "send",
          "args": {
            "body": "$$vars.comment",
            "fromAddress": "$$values.ourEmail",
            "subject": "$$vars.subject",
            "toAddress": "$$vars.toAddress"
          },
          "let": {
            "comment": "$$args.comment",
            "subject": {
              "$concat": [
                "$$user.data.name",
                " mentioned you in a comment."
              ]
            },
            "toAddress": "$$item.email"
          },
          "service": "ses1"
        },
        {
          "action": "null"
        }
      ]
    },
    "sendNotification": {
      "args": [
        {"name": "userIds", "required": true}
      ],
      "pipeline": [
        {
          "action": "find",
          "args": {
            "collection": "users",
            "database": "planner",
            "query": {
              "_id": {
                "$in": "$$vars.userIds"
              }
            }
          },
          "let": {
            "userIds": "$$args.userIds"
          },
          "service": "mdb1"
        },
        {
          "action": "publish",
          "args": {
            "channel": "$$vars.channel",
            "message": {
              "data": {
                "message": "$$vars.message"
              },
              "pn_gcm": {
                "data": {
                  "message": "$$vars.message"
                }
              }
            }
          },
          "let": {
            "channel": "$$item.channel",
            "message": {
              "$concat": [
                "$$user.data.name",
                " mentioned you in a comment"
              ]
            }
          },
          "service": "pn1"
        },
        {
          "action": "null"
        }
      ]
    }
  },
  "authProviders": {
    "oauth2/facebook": {
      "clientId": "APP-ID",
      "clientSecret": "APP-SECRET",
      "metadataFields": [
        "email",
        "name"
      ],
      "redirectURIs": [
        "http://localhost:8001/"
      ]
    },
    "oauth2/google": {
      "clientId": "APP-ID",
      "clientSecret": "APP-SECRET",
      "metadataFields": [
        "email",
        "name"
      ],
      "redirectURIs": [
        "http://localhost:8001/"
      ]
    }
  },
  "services": {
    "mdb1": {
      "config": {
        "uri": "mongodb://localhost:27017"
      },
      "rules": {
        "5888d4c3772e2e4a41158d65": {
          "_id": "5888d4c3772e2e4a41158d65",
          "fields": {
            "_id": {},
            "lcount": {},
            "lists": {
              "otherFields": {}
            },
            "members": {},
            "name": {
              "required": true,
              "valid": {
                "$$this": {
                  "$ne": ""
                }
              }
            },
            "owner_id": {}
          },
          "namespace": "planner.boards",
          "read": {
            "$or": [
              {
                "$$root.owner_id": "$$user.id"
              },
              {
                "$$root.members": "$$user.id"
              }
            ]
          },
          "valid": {
            "$or": [
              {
                "$$prevRoot": {
                  "$exists": 1
                }
              },
              {
                "$$root.name": {
                  "$nin": "$$pipelines.myBoards.name"
                }
              }
            ]
          },
          "write": {
            "$or": [
              {
                "$$prevRoot.owner_id": "$$user.id"
              },
              {
                "$$prevRoot": {
                  "$exists": false
                }
              }
            ]
          }
        },
        "5888d4c3772e2e4a41158d66": {
          "_id": "5888d4c3772e2e4a41158d66",
          "fields": {
            "_id": {
              "write": {
                "$$prev": {
                  "$exists": false
                }
              }
            },
            "author": {
              "valid": {
                "$$this": "$$user.id"
              },
              "write": {
                "$$prev": {
                  "$exists": false
                }
              }
            },
            "comments": {
              "elements": {},
              "write": {
                "$or": [
                  {
                    "$$prevRoot.author": "$$user.id"
                  }
                ]
              }
            },
            "description": {
              "write": {
                "$or": [
                  {
                    "$$prev": {
                      "$exists": false
                    }
                  },
                  {
                    "$$prevRoot.author": "$$user.id"
                  }
                ]
              }
            },
            "files": {
              "write": {
                "$or": [
                  {
                    "$$prevRoot.author": "$$user.id"
                  }
                ]
              }
            },
            "summary": {
              "valid": {
                "$and": [
                  {
                    "$$this": {
                      "$type": "string"
                    }
                  },
                  {
                    "$$this": {
                      "$ne": ""
                    }
                  }
                ]
              },
              "write": {
                "$or": [
                  {
                    "$$prev": {
                      "$exists": false
                    }
                  },
                  {
                    "$$prevRoot.author": "$$user.id"
                  }
                ]
              }
            }
          },
          "read":{},
          "write":{},
          "valid":{},

          "namespace": "planner.cards"
        },
        "5888d4c3772e2e4a41158d68": {
          "_id": "5888d4c3772e2e4a41158d68",
          "fields": {
            "_id": {},
            "authId": {
              "valid": {
                "$$this": "$$user.id"
              }
            },
            "channel": {
              "read": {
                "$$root.authId": "$$user.id"
              }
            },
            "email": {},
            "name": {}
          },
          "namespace": "planner.users",
          "read": {
            "$$root.authId": "$$user.id"
          },
          "write": {
            "$$prev": {
              "$exists": false
            }
          }
        }
      },
      "type": "mongodb"
    },
    "pn1": {
      "config": {
        "publishKey": "PUB-KEY",
        "subscribeKey": "SUB-KEY"
      },
      "rules": {
        "5888d4c3772e2e4a41158d6a": {
          "_id": "5888d4c3772e2e4a41158d6a",
          "actions": [
            "publish"
          ]
        }
      },
      "type": "pubnub"
    },
    "s31": {
      "config": {
        "accessKeyId": "ACCESS-KEY-ID",
        "region": "us-east-1",
        "secretAccessKey": "SECRET-ACCESS-KEY"
      },
      "rules": {
        "5888d4c3772e2e4a41158d64": {
          "_id": "5888d4c3772e2e4a41158d64",
          "acl": "public-read",
          "actions": [
            "signPolicy"
          ],
          "bucket": "$$values.s3bucket",
          "contentType": "text/plain",
          "maxLength": 1048576
        }
      },
      "type": "aws-s3"
    },
    "ses1": {
      "config": {
        "accessKeyId": "ACCESS-KEY-ID",
        "region": "us-east-1",
        "secretAccessKey": "SECRET-ACCESS-KEY"
      },
      "rules": {
        "5888d4c3772e2e4a41158d69": {
          "_id": "5888d4c3772e2e4a41158d69",
          "actions": [
            "send"
          ]
        }
      },
      "type": "aws-ses"
    }
  },
  "pipelines": {
    "myBoards": {
      "output": "array",
      "pipeline": [
        {
          "action": "find",
          "args": {
            "collection": "boards",
            "database": "planner",
            "project": {
              "name": 1
            },
            "query": {
              "owner_id": "$$user.id"
            }
          },
          "service": "mdb1"
        }
      ]
    },
  },
  "values": {
    "ourEmail": {
      "value": "email@domain.com"
    },
    "s3bucket": {
      "private": true,
      "value": "planner-files"
    }
  }
}
