{
  "name": "planner",
  "authProviders": {
    "oauth2/facebook": {
      "metadataFields": [
        "email",
        "name"
      ],
      "clientId": "APP-ID",
      "clientSecret": "APP-SECRET"
    },
    "oauth2/google": {
      "metadataFields": [
        "email",
        "name"
      ],
      "clientId": "APP-SECRET",
      "clientSecret": "APP-ID"
    }
  },
  "actions": {
    "sendEmail": {
      "pipeline": [
        {
          "service": "mdb1",
          "action": "find",
          "args": {
            "database": "planner",
            "collection": "users",
            "query": {
              "_id": {
                "$in": "$$action.userIds"
              }
            }
          }
        },
        {
          "service": "ses1",
          "action": "send",
          "args": {
            "fromAddress": "$$var.ourEmail",
            "toAddress": "$$item.email",
            "subject": {
              "$concat": [
                "$$auth.data.name",
                " mentioned you in a comment."
              ]
            },
            "body": "$$action.comment"
          }
        },
        {
          "action": "null"
        }
      ],
      "args": [
        "userIds",
        "comment"
      ]
    },
    "sendNotification": {
      "pipeline": [
        {
          "service": "mdb1",
          "action": "find",
          "args": {
            "database": "planner",
            "collection": "users",
            "query": {
              "_id": {
                "$in": "$$action.userIds"
              }
            }
          }
        },
        {
          "service": "pn1",
          "action": "publish",
          "args": {
            "channel": "$$item.channel",
            "message": {
              "data": {
                "message": {
                  "$concat": [
                    "$$auth.data.name",
                    " mentioned you in a comment"
                  ]
                }
              },
              "pn_gcm": {
                "data": {
                  "message": {
                    "$concat": [
                      "$$auth.data.name",
                      " mentioned you in a comment"
                    ]
                  }
                }
              }
            }
          }
        },
        {
          "action": "null"
        }
      ],
      "args": [
        "userIds"
      ]
    }
  },
  "services": {
    "s31" : {
      "type":"aws-s3",
      "config": {
        "accessKeyId": "ACCESS-KEY-ID",
        "secretAccessKey": "SECRET-ACCESS-KEY",
        "region": "us-east-1"
      },
      "rules": [
        {
          "actions": [ "signPolicy" ],
          "bucket": "$$var.s3bucket",
          "key": {"$regex" : "^/planner-files/"},
          "contentType": "text/plain",
          "acl": "public-read",
          "maxLength": 1048576
        }
      ]
    },
    "mdb1": {
      "type": "mongodb",
      "config": {
        "uri": "mongodb://localhost:27017"
      },
      "rules": [
        {
          "namespace": "planner.boards",
          "read": {
            "$or": [
              {
                "$$root.owner_id": "$$auth.id"
              },
              {
                "$$root.members": "$$auth.id"
              }
            ]
          },
          "write": {
            "$or": [
              {
                "$$oldRoot.owner_id": "$$auth.id"
              },
              { "$$oldRoot": { "$exists": false } }
            ]
          },
          "valid": {
            "$or": [
              {
                "$$oldRoot": {
                  "$exists": 1
                }
              },
              {
                "$$newRoot.name": {
                  "$nin": "$$var.myBoards.name"
                }
              }
            ]
          },
          "fields": {
            "_id": {
            },
            "name": {
              "required": true,
              "valid": {
                "$$new": {
                  "$ne": ""
                }
              }
            },
            "owner_id": {
              
            },
            "lists": {
              "otherFields": {}
            },
            "lcount": {},
            "members": {}
          }
        },
        {
          "namespace": "planner.cards",
          "fields": {
            "_id": {
              "write": {
                "$$old": {
                  "$exists": false
                }
              }
            },
            "author": {
              "write": {
                "$$old": {
                  "$exists": false
                }
              },
              "valid": {
                "$$new": "$$auth.id"
              }
            },
            "summary": {
              "write": {
                "$or": [{"$$old": {"$exists": false}}, {"$$oldRoot.author": "$$auth.id"}]
              },
              "valid": {
                "$and": [
                  {
                    "$$new": {
                      "$type": "string"
                    }
                  },
                  {
                    "$$new": {
                      "$ne": ""
                    }
                  }
                ]
              }
            },
            "comments": {
              "write": {
                "$or": [{"$$oldRoot.author": "$$auth.id"}]
              }
            },
            "files": {
              "write": {
                "$or": [{"$$oldRoot.author": "$$auth.id"}]
              }
            },
            "description": {
              "write": {
                "$or": [{"$$old": {"$exists": false}}, {"$$oldRoot.author": "$$auth.id"}]
              }
            }
          }
        },
        {
          "namespace": "planner.users",
          "read": {"$$root.authId": "$$auth.id"},
          "write": {
            "$$old": {
              "$exists": false
            }
          },
          "fields": {
            "_id": {},
            "authId": {
              "valid": {
                "$$new": "$$auth.id"
              }
            },
            "email": {},
            "name": {},
            "channel": {
              "read": {
                "$$root.authId": "$$auth.id"
              }
            }
          }
        }
      ]
    },
    "ses1": {
      "type": "aws-ses",
      "config": {
        "region": "us-east-1",
        "accessKeyId": "ACCESS-KEY-ID",
        "secretAccessKey": "SECRET-ACCESS-KEY"
      },
      "rules": [
        {
          "actions": [
            "send"
          ]
        }
      ]
    },
    "pn1": {
      "type": "pubnub",
      "config": {
        "subscribeKey": "SUB-KEY",
        "publishKey": "PUB-KEY"
      },
      "rules": [
        {
          "actions": [
            "publish"
          ]
        }
      ]
    }
  },
  "variables": {
    "s3bucket" : {
      "type": "literal",
      "source": "planner-files"
    },
    "ourEmail": {
      "type": "literal",
      "source": "email@domain.com"
    },
    "myBoards": {
      "type": "pipeline",
      "source": {
        "pipeline": [
          {
            "service": "mdb1",
            "action": "find",
            "args": {
              "database": "planner",
              "collection": "boards",
              "query": {
                "owner_id": "$$auth.id"
              },
              "project": {
                "name": 1
              }
            }
          }
        ],
        "output": "array"
      }
    }
  }
}
