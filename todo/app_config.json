{
	"name": "todo",
	"authProviders": {
		"oauth2/google": {
			"metadataFields": ["email", "name", "picture"],
			"clientId": "APP-ID",
			"clientSecret": "APP-SECRET",
			"redirectURIs": ["http://localhost:8001"]
		},
		"oauth2/facebook": {
			"metadataFields": ["email", "name", "picture"],
			"clientId": "APP-ID",
			"clientSecret": "APP-SECRET",
			"redirectURIs": ["http://localhost:8001"]
		}
	},

	"services": {
		"mdb1": {
			"type": "mongodb",
			"config": {
				"uri": "mongodb://localhost:27017"
			},
			"rules": [
				{
					"namespace": "todo.items",
					"filters": [{"matchExpression": {"user": "$$auth.id"}, "when": {"$$true": true}}],
					"read": {"$$root.user": "$$auth.id"},
					"write": {"$or": [{"$$oldRoot.user": "$$auth.id"}, {"$$oldRoot": {"$exists": 0}}]},
					"fields": {
						"_id": {
							
						},
						"text": {
							"valid": {"$$new": {"$type": "string"}, "$$new": {"$ne": ""}}
						},
						"user": {
							"valid": "$$auth.id"
						},
						"checked": {
							"valid": {"$$new": {"$type": "bool"}}
						}
					}
				},
				{
					"namespace": "todo.users",
					"filters": [{"matchExpression": {"user": "$$auth.id"}, "when": {"$$true": true}}],
					"read": {"$$root.user": "$$auth.id"},
					"write": {"$or": [{"$$oldRoot.id": "$$auth.id"}, {"$$oldRoot": {"$exists": 0}}]},
					"fields": {
						"_id": {
							"valid": "$$auth.id"
						},
						"phone_number": {
							"valid": {
								"$$new": {"$type": "string"},
								"$or": [
									{"$$new": {"$eq": ""}, "$$newRoot.number_status": "unverified"},
									{"$$new": {"$ne": ""}, "$$newRoot.number_status": {"$in": ["pending", "verified"]}}
								]
							}
						},
						"number_status": {
							"valid": { "$$new": {"$in": ["pending", "unverified", "verified"]}}
						},
						"verify_code": {
							"valid": {"$$newRoot.number_status": {"$in": ["pending", "verified"]}}
						}
					}
				}
			]
		},

		"tw1": {
			"type": "twilio",
			"config": {
				"auth_token": "AUTH_TOKEN",
				"sid": "SID"
			},
			"rules": [
				{
					"actions": ["send"]
				}
			],
			"triggers": [
				{
					"pipeline": [
						{
							"action": "expr",
							"args": {
								"expression": {
									"user": "$$var.id_from_phone._id",
									"text": "$$trigger.Body"
								}
							}
						},
						{
							"service": "mdb1",
							"action": "insert",
							"args": {"database": "todo", "collection": "items"}
						}
					],

					"variables": {
						"id_from_phone": {
							"type": "pipeline",
							"source": {
								"pipeline": [
									{
										"service": "mdb1",
										"action": "find",
										"args": {
											"database": "todo",
											"collection": "users", 
											"query": {"phone_number": "$$trigger.From"}
										}
									}
								],
								"output": "singleDoc"
							}
						}
					}
				}
			]
		}
	},

	"variables": {
		"ourNumber": {
			"type": "literal",
			"source": "OUR_NUMBER"
		}
	}
}
