{
  "actions": {
    "sendEmail": {
      "args": [
        "userIds",
        "comment"
      ],
      "pipeline": [
        {
          "action": "find",
          "args": {
            "collection": "users",
            "database": "planner",
            "query": {
              "_id": {
                "$in": "$$action.userIds"
              }
            }
          },
          "service": "mdb1"
        },
        {
          "action": "send",
          "args": {
            "body": "$$action.comment",
            "fromAddress": "$$var.ourEmail",
            "subject": {
              "$concat": [
                "$$auth.data.name",
                " mentioned you in a comment."
              ]
            },
            "toAddress": "$$item.email"
          },
          "service": "ses1"
        },
        {
          "action": "null"
        }
      ]
    },
    "sendNotification": {
      "args": [
        "userIds"
      ],
      "pipeline": [
        {
          "action": "find",
          "args": {
            "collection": "users",
            "database": "planner",
            "query": {
              "_id": {
                "$in": "$$action.userIds"
              }
            }
          },
          "service": "mdb1"
        },
        {
          "action": "publish",
          "args": {
            "channel": "$$item.channel",
            "message": {
              "data": {
                "message": {
                  "$concat": [
                    "$$auth.data.name",
                    " mentioned you in a comment"
                  ]
                }
              },
              "pn_gcm": {
                "data": {
                  "message": {
                    "$concat": [
                      "$$auth.data.name",
                      " mentioned you in a comment"
                    ]
                  }
                }
              }
            }
          },
          "service": "pn1"
        },
        {
          "action": "null"
        }
      ]
    }
  },
  "authProviders": {
    "oauth2/facebook": {
      "clientId": "APP-ID",
      "clientSecret": "APP-SECRET",
      "metadataFields": [
        "email",
        "name"
      ],
      "redirectURIs": [
        "http://localhost:8001/"
      ]
    },
    "oauth2/google": {
      "clientId": "APP-ID",
      "clientSecret": "APP-SECRET",
      "metadataFields": [
        "email",
        "name"
      ],
      "redirectURIs": [
        "http://localhost:8001/"
      ]
    }
  },
  "services": {
    "mdb1": {
      "config": {
        "uri": "mongodb://localhost:27017"
      },
      "rules": {
        "5888d4c3772e2e4a41158d65": {
          "_id": "5888d4c3772e2e4a41158d65",
          "fields": {
            "_id": {},
            "lcount": {},
            "lists": {
              "otherFields": {}
            },
            "members": {},
            "name": {
              "required": true,
              "valid": {
                "$$new": {
                  "$ne": ""
                }
              }
            },
            "owner_id": {}
          },
          "namespace": "planner.boards",
          "read": {
            "$or": [
              {
                "$$root.owner_id": "$$auth.id"
              },
              {
                "$$root.members": "$$auth.id"
              }
            ]
          },
          "valid": {
            "$or": [
              {
                "$$oldRoot": {
                  "$exists": 1
                }
              },
              {
                "$$newRoot.name": {
                  "$nin": "$$var.myBoards.name"
                }
              }
            ]
          },
          "write": {
            "$or": [
              {
                "$$oldRoot.owner_id": "$$auth.id"
              },
              {
                "$$oldRoot": {
                  "$exists": false
                }
              }
            ]
          }
        },
        "5888d4c3772e2e4a41158d66": {
          "_id": "5888d4c3772e2e4a41158d66",
          "fields": {
            "_id": {
              "write": {
                "$$old": {
                  "$exists": false
                }
              }
            },
            "author": {
              "valid": {
                "$$new": "$$auth.id"
              },
              "write": {
                "$$old": {
                  "$exists": false
                }
              }
            },
            "comments": {
              "write": {
                "$or": [
                  {
                    "$$oldRoot.author": "$$auth.id"
                  }
                ]
              }
            },
            "description": {
              "write": {
                "$or": [
                  {
                    "$$old": {
                      "$exists": false
                    }
                  },
                  {
                    "$$oldRoot.author": "$$auth.id"
                  }
                ]
              }
            },
            "files": {
              "write": {
                "$or": [
                  {
                    "$$oldRoot.author": "$$auth.id"
                  }
                ]
              }
            },
            "summary": {
              "valid": {
                "$and": [
                  {
                    "$$new": {
                      "$type": "string"
                    }
                  },
                  {
                    "$$new": {
                      "$ne": ""
                    }
                  }
                ]
              },
              "write": {
                "$or": [
                  {
                    "$$old": {
                      "$exists": false
                    }
                  },
                  {
                    "$$oldRoot.author": "$$auth.id"
                  }
                ]
              }
            }
          },
          "namespace": "planner.cards"
        },
        "5888d4c3772e2e4a41158d68": {
          "_id": "5888d4c3772e2e4a41158d68",
          "fields": {
            "_id": {},
            "authId": {
              "valid": {
                "$$new": "$$auth.id"
              }
            },
            "channel": {
              "read": {
                "$$root.authId": "$$auth.id"
              }
            },
            "email": {},
            "name": {}
          },
          "namespace": "planner.users",
          "read": {
            "$$root.authId": "$$auth.id"
          },
          "write": {
            "$$old": {
              "$exists": false
            }
          }
        }
      },
      "type": "mongodb"
    },
    "pn1": {
      "config": {
        "publishKey": "PUB-KEY",
        "subscribeKey": "SUB-KEY"
      },
      "rules": {
        "5888d4c3772e2e4a41158d6a": {
          "_id": "5888d4c3772e2e4a41158d6a",
          "actions": [
            "publish"
          ]
        }
      },
      "type": "pubnub"
    },
    "s31": {
      "config": {
        "accessKeyId": "ACCESS-KEY-ID",
        "region": "us-east-1",
        "secretAccessKey": "SECRET-ACCESS-KEY"
      },
      "rules": {
        "5888d4c3772e2e4a41158d64": {
          "_id": "5888d4c3772e2e4a41158d64",
          "acl": "public-read",
          "actions": [
            "signPolicy"
          ],
          "bucket": "$$var.s3bucket",
          "contentType": "text/plain",
          "maxLength": 1048576
        }
      },
      "type": "aws-s3"
    },
    "ses1": {
      "config": {
        "accessKeyId": "ACCESS-KEY-ID",
        "region": "us-east-1",
        "secretAccessKey": "SECRET-ACCESS-KEY"
      },
      "rules": {
        "5888d4c3772e2e4a41158d69": {
          "_id": "5888d4c3772e2e4a41158d69",
          "actions": [
            "send"
          ]
        }
      },
      "type": "aws-ses"
    }
  },
  "variables": {
    "myBoards": {
      "source": {
        "output": "array",
        "pipeline": [
          {
            "action": "find",
            "args": {
              "collection": "boards",
              "database": "planner",
              "project": {
                "name": 1
              },
              "query": {
                "owner_id": "$$auth.id"
              }
            },
            "service": "mdb1"
          }
        ]
      },
      "type": "pipeline"
    },
    "ourEmail": {
      "source": "email@domain.com",
      "type": "literal"
    },
    "s3bucket": {
      "private": true,
      "source": "planner-files",
      "type": "literal"
    }
  }
}